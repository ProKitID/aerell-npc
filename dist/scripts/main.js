import{CommandPermissionLevel,CustomCommandParamType,CustomCommandStatus,Player,system as system2,world}from"@minecraft/server";import{ActionFormData}from"@minecraft/server-ui";import{system}from"@minecraft/server";var StructureDetector=class _StructureDetector{static{this.instances=[]}constructor(patternTypes,basePattern,summonEntity){this.patternTypes=patternTypes;this.basePattern=basePattern;this.triggerBlock=this.patternTypes[Object.keys(this.patternTypes).pop()];this.transformedPatterns=this.generateAllTransformations();this.summonEntity=summonEntity;_StructureDetector.instances.push(this)}generateAllTransformations(){const transformations=[];const seen=new Map;const baseTransforms=[this.basePattern,_StructureDetector.flipEntirePattern(this.basePattern),_StructureDetector.transposeYZ(this.basePattern),_StructureDetector.transposeXY(this.basePattern)];for(let current of baseTransforms){for(let i=0;i<4;i++){this.addUniquePattern(transformations,seen,current);this.addUniquePattern(transformations,seen,current.map(layer=>_StructureDetector.flipLayerHorizontal(layer)));this.addUniquePattern(transformations,seen,current.map(layer=>_StructureDetector.flipLayerVertical(layer)));current=current.map(layer=>_StructureDetector.rotateLayer(layer))}}return transformations}addUniquePattern(transformations,seen,pattern){const hash=this.hashPattern(pattern);if(!seen.has(hash)){seen.set(hash,true);transformations.push(pattern)}}hashPattern(pattern){return pattern.map(layer=>layer.join("|")).join("||")}detectStructure(dimension,block){if(block.typeId!==this.triggerBlock)return;system.runJob(this.detectAllPatternsJob(dimension,block))}*detectAllPatternsJob(dimension,block){const state={isDone:false};for(const transformed of this.transformedPatterns){if(state.isDone)return;const triggers=this.getTriggerBlockOffsets(transformed);for(const offset of triggers){if(state.isDone)return;const origin={x:Math.floor(block.location.x-offset.x),y:Math.floor(block.location.y-offset.y),z:Math.floor(block.location.z-offset.z)};yield*this.checkStructureJob(dimension,origin,transformed,state)}}}getTriggerBlockOffsets(pattern){const offsets=[];for(let y=0;y<pattern.length;y++){for(let z=0;z<pattern[y].length;z++){for(let x=0;x<pattern[y][z].length;x++){if(this.patternTypes[pattern[y][z][x]]===this.triggerBlock){offsets.push({x,y,z})}}}}return offsets}*checkStructureJob(dimension,origin,pattern,state){if(state.isDone)return;let count=0;for(let y=0;y<pattern.length;y++){for(let z=0;z<pattern[y].length;z++){for(let x=0;x<pattern[y][z].length;x++){const expected=this.patternTypes[pattern[y][z][x]];if(!expected)continue;const pos={x:origin.x+x,y:origin.y+y,z:origin.z+z};const block=dimension.getBlock(pos);if(!block||block.typeId!==expected)return;if(++count%5===0)yield}}}if(state.isDone)return;state.isDone=true;yield*this.removeStructureChunkedJob(dimension,origin,pattern);this.summonEntity(dimension,origin)}*removeStructureChunkedJob(dimension,origin,pattern){let count=0;for(let y=0;y<pattern.length;y++){for(let z=0;z<pattern[y].length;z++){for(let x=0;x<pattern[y][z].length;x++){if(this.patternTypes[pattern[y][z][x]]){const pos={x:origin.x+x,y:origin.y+y,z:origin.z+z};const block=dimension.getBlock(pos);block?.setType("minecraft:air");if(++count%5===0)yield}}}}}static rotateLayer(layer){const rotated=[];for(let col=0;col<layer[0].length;col++){let row="";for(let rowIndex=layer.length-1;rowIndex>=0;rowIndex--){row+=layer[rowIndex][col]}rotated.push(row)}return rotated}static flipLayerHorizontal(layer){return layer.map(row=>row.split("").reverse().join(""))}static flipLayerVertical(layer){return[...layer].reverse()}static flipEntirePattern(pattern){return pattern.map(layer=>this.flipLayerVertical(layer)).reverse()}static transposeYZ(pattern){const result=[];for(let z=0;z<pattern[0].length;z++){const layer=[];for(let y=0;y<pattern.length;y++){layer.push([...pattern[y][z]].join(""))}result.push(layer)}return result}static transposeXY(pattern){const result=[];for(let y=0;y<pattern.length;y++){const layer=[];for(let x=0;x<pattern[0][0].length;x++){let row="";for(let z=0;z<pattern[0].length;z++){row+=pattern[y][z][x]}layer.push(row)}result.push(layer)}return result}};var structureDetector_default=StructureDetector;var NAME="Aerell NPC";var IDENTIFIER_PREFIX="aerell";var VERSION="1.0.0";var NPC="npc";var NPC_COMMAND_NAME=`${IDENTIFIER_PREFIX}:${NPC}`;var NPC_COMMAND_ENUM_PREFIX_NAME=`${IDENTIFIER_PREFIX}:prefix`;var NPC_ENTITY_TYPE_ID=NPC_COMMAND_NAME;var npcCommand={name:NPC_COMMAND_NAME,description:"Aerell NPC Commands",permissionLevel:CommandPermissionLevel.Any,cheatsRequired:false,mandatoryParameters:[{name:NPC_COMMAND_ENUM_PREFIX_NAME,type:CustomCommandParamType.Enum}]};var npcCommandCallBack=(origin,prefix)=>{const source=origin.initiator??origin.sourceEntity;if(!(source instanceof Player))return{status:CustomCommandStatus.Failure,message:"This command can only be executed by players."};if(prefix=="version")return{status:CustomCommandStatus.Success,message:`\xA7e${NAME} version ${VERSION}`};return{status:CustomCommandStatus.Failure}};system2.beforeEvents.startup.subscribe(event=>{event.customCommandRegistry.registerEnum(NPC_COMMAND_ENUM_PREFIX_NAME,["version"]);event.customCommandRegistry.registerCommand(npcCommand,npcCommandCallBack)});world.beforeEvents.playerInteractWithEntity.subscribe(event=>{const itemStack=event.itemStack;const player=event.player;const target=event.target;if(target.typeId==NPC_ENTITY_TYPE_ID&&(itemStack?.typeId??"")!="minecraft:name_tag"){system2.run(()=>{new ActionFormData().title("Aerell NPC - Menu").label(`Name: ${target.nameTag}`).label(`Health: ${target.getComponent("minecraft:health")?.currentValue}`).show(player).then(value=>{if(value.canceled)return})})}});var detector=new structureDetector_default({"*":"minecraft:air","d":"minecraft:dirt","p":"minecraft:player_head"},[["d"],["d"],["p"]],(dimension,pos)=>{dimension.spawnEntity(NPC_ENTITY_TYPE_ID,pos)});world.afterEvents.playerPlaceBlock.subscribe(({block,dimension})=>{detector.detectStructure(dimension,block)});

//# sourceMappingURL=../debug/main.js.map
