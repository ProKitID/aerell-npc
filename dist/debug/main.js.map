{"version":3,"sources":["../../scripts/main.ts","../../scripts/modules/structureDetector.ts"],"sourcesContent":["import {\n    type CustomCommand,\n    type CustomCommandResult,\n    CommandPermissionLevel,\n    CustomCommandParamType,\n    CustomCommandOrigin,\n    CustomCommandStatus,\n    Player,\n    system,\n    world,\n} from '@minecraft/server';\n\nimport {\n    ActionFormData,\n} from '@minecraft/server-ui';\n\nimport StructureDetector from './modules/structureDetector';\n\nconst NAME = 'Aerell NPC';\nconst IDENTIFIER_PREFIX = 'aerell';\nconst VERSION = '1.0.0';\n\nconst NPC = 'npc';\n\nconst NPC_COMMAND_NAME = `${IDENTIFIER_PREFIX}:${NPC}`;\nconst NPC_COMMAND_ENUM_PREFIX_NAME = `${IDENTIFIER_PREFIX}:prefix`;\n\nconst NPC_ENTITY_TYPE_ID = NPC_COMMAND_NAME;\n\nconst npcCommand: CustomCommand = {\n    name: NPC_COMMAND_NAME,\n    description: 'Aerell NPC Commands',\n    permissionLevel: CommandPermissionLevel.Any,\n    cheatsRequired: false,\n    mandatoryParameters: [\n        {\n            name: NPC_COMMAND_ENUM_PREFIX_NAME,\n            type: CustomCommandParamType.Enum\n        }\n    ]\n};\n\nconst npcCommandCallBack = (origin: CustomCommandOrigin, prefix: string): CustomCommandResult => {\n    const source = origin.initiator ?? origin.sourceEntity;\n\n    if (!(source instanceof Player)) return {\n        status: CustomCommandStatus.Failure,\n        message: 'This command can only be executed by players.'\n    };\n\n    if (prefix == 'version') return {\n        status: CustomCommandStatus.Success,\n        message: `Â§e${NAME} version ${VERSION}`\n    };\n\n    return {\n        status: CustomCommandStatus.Failure\n    };\n};\n\nsystem.beforeEvents.startup.subscribe((event) => {\n    event.customCommandRegistry.registerEnum(NPC_COMMAND_ENUM_PREFIX_NAME, ['version']);\n    event.customCommandRegistry.registerCommand(npcCommand, npcCommandCallBack);\n});\n\nworld.beforeEvents.playerInteractWithEntity.subscribe((event) => {\n    const itemStack = event.itemStack;\n    const player = event.player;\n    const target = event.target;\n    if (target.typeId == NPC_ENTITY_TYPE_ID && (itemStack?.typeId ?? '') != 'minecraft:name_tag') {\n        system.run(() => {\n            new ActionFormData()\n            .title('Aerell NPC - Menu')\n            .label(`Name: ${target.nameTag}`)\n            .label(`Health: ${target.getComponent('minecraft:health')?.currentValue}`)\n            .show(player).then((value) => {\n                if (value.canceled) return;\n            });\n        })\n    }\n});\n\nconst detector = new StructureDetector(\n    {\n        \"*\": \"minecraft:air\",\n        \"d\": \"minecraft:dirt\",\n        \"p\": \"minecraft:player_head\" // the block that trigger the check.\n    },\n    [\n        [\"d\"],\n        [\"d\"],\n        [\"p\"]\n    ],\n    (dimension: { spawnEntity: (arg0: string, arg1: any) => void; }, pos: any) => {\n        dimension.spawnEntity(NPC_ENTITY_TYPE_ID, pos);\n    }\n);\n\nworld.afterEvents.playerPlaceBlock.subscribe(({ block, dimension }) => {\n    detector.detectStructure(dimension, block);\n});\n","/*\nCredit{Source}: https://github.com/MinecraftBedrockArabic/Script-API-snippets/blob/main/structure summon detector/structureDetector.js\n*/\n\nimport { system, Dimension, Block, type Vector3 } from \"@minecraft/server\";\n\nexport type Pattern3D = string[][]; // 3D: [y][z][x]\nexport type PatternTypes = Record<string, string>; // \"A\": \"minecraft:stone\"\n\nexport type SummonEntityFn = (dimension: Dimension, origin: Vector3) => void;\n\ninterface Offset {\n    x: number;\n    y: number;\n    z: number;\n}\n\ninterface StateFlag {\n    isDone: boolean;\n}\n\nclass StructureDetector {\n    patternTypes: PatternTypes;\n    basePattern: Pattern3D;\n    triggerBlock: string;\n    transformedPatterns: Pattern3D[];\n    summonEntity: SummonEntityFn;\n\n    static instances: StructureDetector[] = [];\n\n    constructor(\n        patternTypes: PatternTypes,\n        basePattern: Pattern3D,\n        summonEntity: SummonEntityFn\n    ) {\n        this.patternTypes = patternTypes;\n        this.basePattern = basePattern;\n        this.triggerBlock = this.patternTypes[Object.keys(this.patternTypes).pop()!]!;\n        this.transformedPatterns = this.generateAllTransformations();\n        this.summonEntity = summonEntity;\n\n        StructureDetector.instances.push(this);\n    }\n\n    /** Generate full pattern transformations */\n    private generateAllTransformations(): Pattern3D[] {\n        const transformations: Pattern3D[] = [];\n        const seen = new Map<string, boolean>();\n\n        const baseTransforms = [\n            this.basePattern,\n            StructureDetector.flipEntirePattern(this.basePattern),\n            StructureDetector.transposeYZ(this.basePattern),\n            StructureDetector.transposeXY(this.basePattern),\n        ];\n\n        for (let current of baseTransforms) {\n            for (let i = 0; i < 4; i++) {\n                this.addUniquePattern(transformations, seen, current);\n                this.addUniquePattern(transformations, seen, current.map(layer => StructureDetector.flipLayerHorizontal(layer)));\n                this.addUniquePattern(transformations, seen, current.map(layer => StructureDetector.flipLayerVertical(layer)));\n\n                current = current.map(layer => StructureDetector.rotateLayer(layer));\n            }\n        }\n\n        return transformations;\n    }\n\n    private addUniquePattern(\n        transformations: Pattern3D[],\n        seen: Map<string, boolean>,\n        pattern: Pattern3D\n    ) {\n        const hash = this.hashPattern(pattern);\n        if (!seen.has(hash)) {\n            seen.set(hash, true);\n            transformations.push(pattern);\n        }\n    }\n\n    private hashPattern(pattern: Pattern3D): string {\n        return pattern.map(layer => layer.join(\"|\")).join(\"||\");\n    }\n\n    /** Triggered on block update */\n    detectStructure(dimension: Dimension, block: Block) {\n        if (block.typeId !== this.triggerBlock) return;\n        system.runJob(this.detectAllPatternsJob(dimension, block));\n    }\n\n    private *detectAllPatternsJob(dimension: Dimension, block: Block) {\n        const state: StateFlag = { isDone: false };\n\n        for (const transformed of this.transformedPatterns) {\n            if (state.isDone) return;\n\n            const triggers = this.getTriggerBlockOffsets(transformed);\n\n            for (const offset of triggers) {\n                if (state.isDone) return;\n\n                const origin: Vector3 = {\n                    x: Math.floor(block.location.x - offset.x),\n                    y: Math.floor(block.location.y - offset.y),\n                    z: Math.floor(block.location.z - offset.z),\n                };\n\n                yield* this.checkStructureJob(dimension, origin, transformed, state);\n            }\n        }\n    }\n\n    private getTriggerBlockOffsets(pattern: Pattern3D): Offset[] {\n        const offsets: Offset[] = [];\n\n        for (let y = 0; y < pattern.length; y++) {\n            for (let z = 0; z < pattern[y]!.length; z++) {\n                for (let x = 0; x < pattern[y]![z]!.length; x++) {\n                    if (this.patternTypes[pattern[y]![z]![x]!] === this.triggerBlock) {\n                        offsets.push({ x, y, z });\n                    }\n                }\n            }\n        }\n\n        return offsets;\n    }\n\n    private *checkStructureJob(\n        dimension: Dimension,\n        origin: Vector3,\n        pattern: Pattern3D,\n        state: StateFlag\n    ) {\n        if (state.isDone) return;\n\n        let count = 0;\n\n        for (let y = 0; y < pattern.length; y++) {\n            for (let z = 0; z < pattern[y]!.length; z++) {\n                for (let x = 0; x < pattern[y]![z]!.length; x++) {\n                    const expected = this.patternTypes[pattern[y]![z]![x]!];\n                    if (!expected) continue;\n\n                    const pos = { x: origin.x + x, y: origin.y + y, z: origin.z + z };\n                    const block = dimension.getBlock(pos);\n\n                    if (!block || block.typeId !== expected) return;\n\n                    if (++count % 5 === 0) yield;\n                }\n            }\n        }\n\n        if (state.isDone) return;\n        state.isDone = true;\n\n        yield* this.removeStructureChunkedJob(dimension, origin, pattern);\n        this.summonEntity(dimension, origin);\n    }\n\n    private *removeStructureChunkedJob(\n        dimension: Dimension,\n        origin: Vector3,\n        pattern: Pattern3D\n    ) {\n        let count = 0;\n\n        for (let y = 0; y < pattern.length; y++) {\n            for (let z = 0; z < pattern[y]!.length; z++) {\n                for (let x = 0; x < pattern[y]![z]!.length; x++) {\n                    if (this.patternTypes[pattern[y]![z]![x]!]) {\n                        const pos = {\n                            x: origin.x + x,\n                            y: origin.y + y,\n                            z: origin.z + z,\n                        };\n                        const block = dimension.getBlock(pos);\n                        block?.setType(\"minecraft:air\");\n\n                        if (++count % 5 === 0) yield;\n                    }\n                }\n            }\n        }\n    }\n\n    // -------------------- Static Pattern Operations --------------------\n\n    static rotateLayer(layer: string[]): string[] {\n        const rotated: string[] = [];\n        for (let col = 0; col < layer[0]!.length; col++) {\n            let row = \"\";\n            for (let rowIndex = layer.length - 1; rowIndex >= 0; rowIndex--) {\n                row += layer[rowIndex]![col];\n            }\n            rotated.push(row);\n        }\n        return rotated;\n    }\n\n    static flipLayerHorizontal(layer: string[]): string[] {\n        return layer.map(row => row.split(\"\").reverse().join(\"\"));\n    }\n\n    static flipLayerVertical(layer: string[]): string[] {\n        return [...layer].reverse();\n    }\n\n    static flipEntirePattern(pattern: Pattern3D): Pattern3D {\n        return pattern.map(layer => this.flipLayerVertical(layer)).reverse();\n    }\n\n    static transposeYZ(pattern: Pattern3D): Pattern3D {\n        const result: Pattern3D = [];\n        for (let z = 0; z < pattern[0]!.length; z++) {\n            const layer: string[] = [];\n            for (let y = 0; y < pattern.length; y++) {\n                layer.push([...pattern[y]![z]!].join(\"\"));\n            }\n            result.push(layer);\n        }\n        return result;\n    }\n\n    static transposeXY(pattern: Pattern3D): Pattern3D {\n        const result: Pattern3D = [];\n        for (let y = 0; y < pattern.length; y++) {\n            const layer: string[] = [];\n            for (let x = 0; x < pattern[0]![0]!.length; x++) {\n                let row = \"\";\n                for (let z = 0; z < pattern[0]!.length; z++) {\n                    row += pattern[y]![z]![x]!;\n                }\n                layer.push(row);\n            }\n            result.push(layer);\n        }\n        return result;\n    }\n}\n\nexport default StructureDetector;\n"],"mappings":"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","names":["system","system"],"file":"../scripts/main.js"}